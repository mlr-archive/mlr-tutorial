language: r
sudo: false
dist: trusty
cache: packages
pip: true

branches:
    only:
        - gh-pages

env:
  global:
    - _R_CHECK_TIMINGS_=0
    - _R_CHECK_FORCE_SUGGESTS_=0  # no error if suggested packs are not avail
    - _R_CHECK_TESTS_NLINES_=999
    - secure: "d0xff7hriQyReF4y3/iR5sHJlXocKNKcN6/Gi/r9Hxsfuh2Hx3fouQCMSPP+Oba6MDgEvAfryToAxcmaoZByQMwgevB0OBy5xkatj3oTHmhN5Nbk3jNXxXfA6P0Oqxaf7lXVZk2+Ly+PWnbgXn0uhjzdaZo0cWtVJ660ajS0x9Q="
    # include $HOME/.local/bin for `aws`
    - PATH=$HOME/.local/bin:$PATH
  
addons:
  apt:
    packages:
      - libgmp-dev
      - libgsl0-dev
      - pandoc

warnings_are_errors: true
before_install:
  - mkdir -p $HOME/bin
  - ln -s $(which gcc-4.9) $HOME/bin/gcc
  - ln -s $(which g++-4.9) $HOME/bin/g++
  - ln -s $(which gfortran-4.9) $HOME/bin/gfortran
  - export PATH=$HOME/bin:$PATH
  - echo $LD_LIBRARY_PATH
  - echo $LIBRARY_PATH
  # set up awscli packages
  - pip install --user awscli
  - mkdir -p ~/shared
  - aws s3 sync s3://mlr-tutorial/shared ~/shared
  
jobs:
  include:
    - stage: packages
      install:
        - Rscript r_packs_install.R
      script: true
    - stage: build1
      install:
      - |
        travis_wait 60 ./build-1
      script: 
      - true
      - tee > ~/shared/build-1
    - stage: build2
      script:
      - cat ~/shared/*
      install:
      - pip install --user mkdocs
      - pip install --user python-markdown-math
      - |
        travis_wait 60 ./build-2
      script: 
      - true
      - tee > ~/shared/build-2
    - stage: build3
      script:
      - cat ~/shared/*
      script: 
      - true
      - |
        travis_wait 60 ./build-3

after_success:
    - git checkout gh-pages
    - git config user.name $GIT_NAME
    - git config user.email $GIT_EMAIL
    - git config credential.helper "store --file=.git/credentials"
    - echo "https://$GH_TOKEN:@github.com" >> .git/credentials
    - git config push.default matching
    - git add devel
    - git commit -a -m "update auto-generated tutorial pages [ci skip]"
    - git push
    - aws s3 sync ~/shared s3://mlr-tutorial/shared

notifications:
  email:
    recipients:
        - bernd_bischl@gmx.net
        - larsko@cs.ubc.ca
        - schiffner@math.uni-duesseldorf.de
    on_success: change
    on_failure: always
  slack: mlr-org:jiHX1LxqUBJUCJmCioo7vUVl#buildnotifications