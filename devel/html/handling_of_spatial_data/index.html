<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Handling of Spatial Data - mlr tutorial</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/custom_mlr.css" rel="stylesheet">
        <link href="../css/custom_highlight.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">mlr tutorial</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../index.html">Home</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Quick Walkthrough <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../task/index.html">Tasks</a>
</li>
                            
<li >
    <a href="../learner/index.html">Learners</a>
</li>
                            
<li >
    <a href="../train/index.html">Train</a>
</li>
                            
<li >
    <a href="../predict/index.html">Predict</a>
</li>
                            
<li >
    <a href="../preproc/index.html">Preprocessing</a>
</li>
                            
<li >
    <a href="../performance/index.html">Performance</a>
</li>
                            
<li >
    <a href="../resample/index.html">Resampling</a>
</li>
                            
<li >
    <a href="../tune/index.html">Tuning</a>
</li>
                            
<li >
    <a href="../benchmark_experiments/index.html">Benchmark Experiments</a>
</li>
                            
<li >
    <a href="../parallelization/index.html">Parallelization</a>
</li>
                            
<li >
    <a href="../visualization/index.html">Visualization</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../configureMlr/index.html">Configuration</a>
</li>
                            
<li >
    <a href="../wrapper/index.html">Wrapped Learners</a>
</li>
                            
<li >
    <a href="../impute/index.html">Imputation</a>
</li>
                            
<li >
    <a href="../bagging/index.html">Bagging</a>
</li>
                            
<li >
    <a href="../advanced_tune/index.html">Advanced Tuning</a>
</li>
                            
<li >
    <a href="../feature_selection/index.html">Feature Selection</a>
</li>
                            
<li >
    <a href="../nested_resampling/index.html">Nested Resampling</a>
</li>
                            
<li >
    <a href="../cost_sensitive_classif/index.html">Cost-Sensitive Classification</a>
</li>
                            
<li >
    <a href="../over_and_undersampling/index.html">Imbalanced Classification Problems</a>
</li>
                            
<li >
    <a href="../roc_analysis/index.html">ROC Analysis</a>
</li>
                            
<li >
    <a href="../multilabel/index.html">Multilabel Classification</a>
</li>
                            
<li >
    <a href="../learning_curve/index.html">Learning Curves</a>
</li>
                            
<li >
    <a href="../partial_dependence/index.html">Partial Dependence Plots</a>
</li>
                            
<li >
    <a href="../classifier_calibration/index.html">Classifier Calibration Plots</a>
</li>
                            
<li >
    <a href="../hyperpar_tuning_effects/index.html">Hyperparameter Tuning Effects</a>
</li>
                            
<li >
    <a href="../out_of_bag_predictions/index.html">Out-of-Bag Predictions</a>
</li>
                            
<li class="active">
    <a href="index.html">Handling of Spatial Data</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Extending <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../create_learner/index.html">Create Custom Learners</a>
</li>
                            
<li >
    <a href="../create_measure/index.html">Create Custom Measures</a>
</li>
                            
<li >
    <a href="../create_imputation/index.html">Create Imputation Methods</a>
</li>
                            
<li >
    <a href="../create_filter/index.html">Create Custom Filters</a>
</li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Appendix <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../example_tasks/index.html">Example Tasks</a>
</li>
                            
<li >
    <a href="../integrated_learners/index.html">Integrated Learners</a>
</li>
                            
<li >
    <a href="../measures/index.html">Implemented Performance Measures</a>
</li>
                            
<li >
    <a href="../filter_methods/index.html">Integrated Filter Methods</a>
</li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../out_of_bag_predictions/index.html">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../create_learner/index.html">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/mlr-org/mlr/edit/master/docs/handling_of_spatial_data.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#handling-of-spatial-data">Handling of Spatial Data</a></li>
            <li><a href="#introduction">Introduction</a></li>
            <li><a href="#how-to-use-spatial-partitioning-in-mlr">How to use spatial partitioning in mlr</a></li>
            <li><a href="#examples">Examples</a></li>
            <li><a href="#notes">Notes</a></li>
            <li><a href="#complete-code-listing">Complete code listing</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="handling-of-spatial-data">Handling of Spatial Data</h1>
<h2 id="introduction">Introduction</h2>
<p>Spatial data is different from non-spatial data by having a spatial reference information attached to each observation.
This information is usually stored as coordinates, often named <code>x</code> and <code>y</code>.
Coordinates are either stored in UTM (Universal Transverse Mercator) or latitude/longitude format.</p>
<p>Treating spatial data sets like non-spatial ones leads to overoptimistic results in predictive accuracy of models (<a href="https://www.nat-hazards-earth-syst-sci.net/5/853/2005/">Brenning 2005</a>).
This is due to the underlying spatial autocorrelation in the data.
Spatial autocorrelation does occur in all spatial data sets.
Magnitude varies depending on the characteristics of the data set.
The closer observations are located to each other, the more similar they are.</p>
<p>If common validation procedures like cross-validation are applied to such data sets, they assume independence of the observation upfront to provide unbiased estimates.
However, this assumption is violated in the spatial case due to spatial autocorrelation.
Subsequently, non-spatial cross-validation will fail to provide accurate performance estimates.</p>
<p><img alt="Nested Spatial and Non-Spatial Validation" src="../img/spatial_cross_validation.png" title="Nested Spatial and Non-Spatial Validation" /></p>
<p>By doing a random sampling of the data set (i.e., non-spatial sampling), training and test set data are often located directly next to each other (in geographical space).
Hence, the test set will contain observations which are somewhat similar (due to spatial autocorrelation) to observations in the training set.
This leads to the effect that the model, which was trained on the training set, performs quite well on the test data because it already knows it to some degree.</p>
<p>To reduce this bias on the resulting predictive accuracy estimate, <a href="https://www.nat-hazards-earth-syst-sci.net/5/853/2005/">Brenning 2005</a> suggested using spatial partitioning in favor of random partitioning (see Figure 1).
Here, spatial clusters are equal to the number of folds chosen.
These spatially disjoint subsets of the data introduce a spatial distance between training and test set.
This reduces the influence of spatial autocorrelation and subsequently also the overoptimistic predictive accuracy estimates.
The example in Figure 1 shows a five-fold nested cross-validation setting and exhibits the difference between spatial and non-spatial partitioning.
The nested approach is used when hyperparameter tuning is performed.</p>
<h2 id="how-to-use-spatial-partitioning-in-mlr">How to use spatial partitioning in mlr</h2>
<p>Spatial partitioning can be used when performing cross-validation.
In any <a href="http://www.rdocumentation.org/packages/mlr/functions/resample.html">resample</a> call you can choose <code>SpCV</code> or <code>SpRepCV</code> to use it.
While <code>SpCV</code> will perform a spatial cross-validation with only one repetition, <code>SpRepCV</code> gives you the option to choose any number of repetitions.
As a rule of thumb, usually 100 repetitions are used with the aim to reduce variance introduced by partitioning.</p>
<p>There are some prerequisites for this:</p>
<p>When specifying the <a href="../task/index.html">task</a>, you need to provide spatial coordinates through argument <code>coordinates</code>.
The supplied <code>data.frame</code> needs to have the same number of rows as the data and at least two dimensions need to be supplied.
This means that a 3-D partitioning might also work but we have not tested this explicitly.
Coordinates need to be numeric so it is suggested to use a UTM projection.
If this applies, the coordinates will be used for spatial partitioning if <code>SpCV</code> or <code>SpRepCV</code> is selected as resampling strategy.</p>
<h2 id="examples">Examples</h2>
<p>The <code>spatial.task</code> data set serves as an example data set for spatial modeling tasks in <code>mlr</code>.
The <a href="../task/index.html">task</a> argument <code>coordinates</code> is a <code>data.frame</code> with two coordinates that will later be used for the spatial partitioning of the data set.</p>
<p>In this example, the "Random Forest" algorithm (package <a href="http://www.rdocumentation.org/packages/ranger/functions/ranger.html">ranger</a>) is used to model a binomial response variable.</p>
<p>For performance assessment, a repeated spatial cross-validation with 5 folds and 5 repetitions is chosen.</p>
<h3 id="spatial-cross-validation">Spatial Cross-Validation</h3>
<pre><code class="r">data(&quot;spatial.task&quot;)
spatial.task
#&gt; Supervised task: ecuador
#&gt; Type: classif
#&gt; Target: slides
#&gt; Observations: 751
#&gt; Features:
#&gt;    numerics     factors     ordered functionals 
#&gt;          10           0           0           0 
#&gt; Missings: FALSE
#&gt; Has weights: FALSE
#&gt; Has blocking: FALSE
#&gt; Has coordinates: TRUE
#&gt; Classes: 2
#&gt; FALSE  TRUE 
#&gt;   251   500 
#&gt; Positive class: TRUE

learner.rf = makeLearner(&quot;classif.ranger&quot;, predict.type = &quot;prob&quot;)

resampling = makeResampleDesc(&quot;SpRepCV&quot;, fold = 5, reps = 5)

set.seed(123)
out = resample(learner = learner.rf, task = spatial.task,
  resampling = resampling, measures = list(auc))
#&gt; Resampling: repeated spatial cross-validation
#&gt; Measures:             auc
#&gt; [Resample] iter 1:    0.6750295
#&gt; [Resample] iter 2:    0.5390011
#&gt; [Resample] iter 3:    0.7126168
#&gt; [Resample] iter 4:    0.7179386
#&gt; [Resample] iter 5:    0.4481074
#&gt; [Resample] iter 6:    0.6661747
#&gt; [Resample] iter 7:    0.5231959
#&gt; [Resample] iter 8:    0.7140047
#&gt; [Resample] iter 9:    0.7230064
#&gt; [Resample] iter 10:   0.4368742
#&gt; [Resample] iter 11:   0.6793610
#&gt; [Resample] iter 12:   0.6912488
#&gt; [Resample] iter 13:   0.5822304
#&gt; [Resample] iter 14:   0.8494331
#&gt; [Resample] iter 15:   0.6187330
#&gt; [Resample] iter 16:   0.7044860
#&gt; [Resample] iter 17:   0.6549153
#&gt; [Resample] iter 18:   0.6441667
#&gt; [Resample] iter 19:   0.5603976
#&gt; [Resample] iter 20:   0.5034305
#&gt; [Resample] iter 21:   0.6673554
#&gt; [Resample] iter 22:   0.4422466
#&gt; [Resample] iter 23:   0.7228560
#&gt; [Resample] iter 24:   0.7178289
#&gt; [Resample] iter 25:   0.5420875
#&gt; 
#&gt; Aggregated Result: auc.test.mean=0.6294690
#&gt; 

mean(out$measures.test$auc)
#&gt; [1] 0.629469
</code></pre>

<p>We can check for the introduced spatial autocorrelation bias here by performing the same modeling task using a non-spatial partitioning setting.
To do so, we simply choose <code>RepCV</code> instead of <code>SpRepCV</code>.
There is no need to remove <code>coordinates</code> from the task as it is only used if <code>SpCV</code> or <code>SpRepCV</code> is selected as the resampling strategy.</p>
<h3 id="non-spatial-cross-validation">Non-Spatial Cross-Validation</h3>
<pre><code class="r">learner.rf = makeLearner(&quot;classif.ranger&quot;, predict.type = &quot;prob&quot;)

resampling = makeResampleDesc(&quot;RepCV&quot;, fold = 5, reps = 5)

set.seed(123)
out = resample(learner = learner.rf, task = spatial.task,
  resampling = resampling, measures = list(auc))
#&gt; Resampling: repeated cross-validation
#&gt; Measures:             auc
#&gt; [Resample] iter 1:    0.7362637
#&gt; [Resample] iter 2:    0.7651485
#&gt; [Resample] iter 3:    0.8119974
#&gt; [Resample] iter 4:    0.6807436
#&gt; [Resample] iter 5:    0.7441992
#&gt; [Resample] iter 6:    0.7769076
#&gt; [Resample] iter 7:    0.8383069
#&gt; [Resample] iter 8:    0.7276557
#&gt; [Resample] iter 9:    0.7341821
#&gt; [Resample] iter 10:   0.7563874
#&gt; [Resample] iter 11:   0.7542955
#&gt; [Resample] iter 12:   0.7972408
#&gt; [Resample] iter 13:   0.7444000
#&gt; [Resample] iter 14:   0.7083333
#&gt; [Resample] iter 15:   0.7405476
#&gt; [Resample] iter 16:   0.7296736
#&gt; [Resample] iter 17:   0.7212000
#&gt; [Resample] iter 18:   0.7715856
#&gt; [Resample] iter 19:   0.7898859
#&gt; [Resample] iter 20:   0.7915686
#&gt; [Resample] iter 21:   0.7391717
#&gt; [Resample] iter 22:   0.7454031
#&gt; [Resample] iter 23:   0.8092320
#&gt; [Resample] iter 24:   0.7267977
#&gt; [Resample] iter 25:   0.7643745
#&gt; 
#&gt; Aggregated Result: auc.test.mean=0.7562201
#&gt; 

mean(out$measures.test$auc)
#&gt; [1] 0.7562201
</code></pre>

<p>The introduced bias (caused by spatial autocorrelation) in performance in this example is around 0.12 AUROC.</p>
<h2 id="notes">Notes</h2>
<ul>
<li>
<p>Some models are more affected by spatial autocorrelation than others.
In general, it can be said that the more flexible a model is, the more it will profit from underlying spatial autocorrelation.
Simpler models (e.g., GLM) will show less overoptimistic performance estimates.</p>
</li>
<li>
<p>The concept of spatial cross-validation was originally implemented in package <a href="https://pat-s.github.io/sperrorest/index.html">sperrorest</a>.
This package comes with even more partitioning options and the ability to visualize the spatial grouping of folds.
We plan to integrate more functions from <a href="https://pat-s.github.io/sperrorest/index.html">sperrorest</a> into <code>mlr</code> so stay tuned!</p>
</li>
<li>
<p>For more detailed information, see <a href="https://www.nat-hazards-earth-syst-sci.net/5/853/2005/">Brenning 2005</a> and <a href="http://ieeexplore.ieee.org/document/6352393/">Brenning2012</a>.</p>
</li>
</ul>
<h2 id="complete-code-listing">Complete code listing</h2>
<p>The above code without the output is given below:</p>
<pre><code>library(&quot;mlr&quot;)
data(&quot;spatial.task&quot;)
spatial.task

learner.rf = makeLearner(&quot;classif.ranger&quot;, predict.type = &quot;prob&quot;)

resampling = makeResampleDesc(&quot;SpRepCV&quot;, fold = 5, reps = 5)

set.seed(123)
out = resample(learner = learner.rf, task = spatial.task,
  resampling = resampling, measures = list(auc))

mean(out$measures.test$auc)
learner.rf = makeLearner(&quot;classif.ranger&quot;, predict.type = &quot;prob&quot;)

resampling = makeResampleDesc(&quot;RepCV&quot;, fold = 5, reps = 5)

set.seed(123)
out = resample(learner = learner.rf, task = spatial.task,
  resampling = resampling, measures = list(auc))

mean(out$measures.test$auc)
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
